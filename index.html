// please enable JavaScript to see the content // <script>var asHTML=true;</script><script> // this can be used as HTML too!
bootME();

function bootME() {

  window.onerror = function (a, b, c, d, e, f) {
    alert(
      'Error!\n'+
      (typeof a == 'undefined' ? '':'\n'+a)+
      (typeof b == 'undefined' ? '':'\n'+b)+
      (typeof c == 'undefined' ? '':'\n'+c)+
      (typeof d == 'undefined' ? '':'\n'+d)+
      (typeof e == 'undefined' ? '':'\n'+e)+
      (typeof f == 'undefined' ? '':'\n'+f));
  };

  if (window.asHTML) {
    showMD(getText(defaultMD));
    return;
  }

  if (document.body) {
    var bodytext = getText(document.body);
    if (!/^\s*$/.test(bodytext)) {
      var bodypre = document.getElementsByTagName('pre')[0];
      if (bodypre) {
        var bodypretext = getText(bodypre);
        if (bodypretext.replace(/\s/g, '')===bodytext.replace(/\s/g,'')) {
          showMD(bodypre.innerHTML);
          return;
        }
      }

      showMD(document.body.innerHTML);
      return;
    }
  }

  

  function showMD(md) {
    var ifr = elem('iframe', {
      position: 'absolute',
      left: 0, top: 0,
      width: '100%', height: '100%',
      border: 'none'
    });
    ifr.src = 'about:blank';
    document.body.appendChild(ifr);

    var ifrwin = ifr.contentWindow || ifr.window;
    var ifrdoc = ifrwin.document;

    ifrdoc.open();
    ifrdoc.write('<style>'+getText(renderStyle)+'</'+'style><body></body>');
    ifrdoc.close();

    ifrwin.elem = elem;

    var earlyPre = ifrwin.elem('pre', {
      text: md,
      opacity: 0.3
    }, ifrdoc.body);
    var aniPre = ifrwin.elem('div', earlyPre);
    setText(aniPre, 'downloading...');

    setTimeout(function() {ifrwin.focus();}, 10);

    var start = +new Date();
    var downloadAnimation = setInterval(function() { try {
      var current = +new Date();
      var ratio = (current-start)/2000 - (((current-start)/2000)|0);
      ratio = Math.abs(ratio-0.5);
      earlyPre.style.opacity = 0.2+ratio*0.5;
      setText(aniPre, 'downloading '+(current-start)/1000+' seconds ...');
    } catch (error) {
      clearInterval(downloadAnimation);
      alert('animation '+error.message);
    } }, 2);

    if (typeof marked === 'function') {
      withMarked(marked);
      return;
    }

    downloadText('https://rawgit.com/chjj/marked/master/lib/marked.js', function (markedJS) {
      clearInterval(downloadAnimation);
      try {
        ifrwin.eval(
            'function defineMarked() { window.marked = null; with (window) { '+markedJS+'} }');
        ifrwin.defineMarked();
        withMarked(ifrwin.marked);
      }
      catch (renderError) {
        ifrdoc.body.innerHTML = null;
        ifrwin.elem('pre', {
          text: renderError.message+'\n\n'+renderError,
          color: 'tomato'
        }, ifrdoc.body);
      }
    });

    function withMarked(marked) {
      var mdHTML = ifrwin.marked(md);
      ifrdoc.body.innerHTML = mdHTML;

      setTimeout(addTitle, 10);

      function addTitle() {

        var findH1 = ifrdoc.getElementsByTagName('h1')[0] || ifrdoc.getElementsByTagName('h2')[0];

        var domTitle = elem('h1', {
          position: 'fixed',
          top: 0, left: 0,
          width: '100%',
          opacity: 0,
          background: 'white',
          margin: 0,
          padding: '0.5em',
          text: getText(findH1)
        }, ifrdoc.body);

        var forceTitle = false;

        ifrwin.onscroll = onscroll;
        ifrdoc.body.onclick = onclick;
        updateTitleVisibility();

        function onclick() {
          forceTitle = !forceTitle;
          updateTitleVisibility();
        }

        function onscroll() {
          updateTitleVisibility();
        }

        function updateTitleVisibility() {
          if (forceTitle) {
            setVisibility(1);
            return;
          }

          var top = ifrdoc.body.scrollTop || ifrwin.pageYOffset || 0;

          if (!top) {
            setVisibility(0);
          }
          else if (top > domTitle.offsetHeight) {
            setVisibility(1);
          }
          else {
            var v = top / domTitle.offsetHeight;
            setVisibility(v);
          }
        }

        function setVisibility(v) {
          domTitle.style.opacity = v;
        }
      }

    }

  }




  function getText(obj) {
    var result = (/^(STYLE|SCRIPT)$/i.test(obj.tagName) ? obj.text : null) ||
      obj.textContent || (obj.styleSheet ? obj.styleSheet.cssText : null) || obj.innerText || obj.innerHTML || null;

    if (!result && typeof obj === 'function') {
      result = /\/\*(\*(?!\/)|[^*])*\*\//m.exec(obj+'')[0];
      if (result)
        result = result.slice(2, result.length-2);
    }

    return result || null;
  }

  function setText(obj, text) {
    if (!/^BODY$/i.test(obj.tagName) && 'text' in obj)
      obj.text = text;
    else if ('textContent' in obj)
      obj.textContent = text;
    else if ('innerText' in obj)
      obj.innerText = text;
    else if ('innerHTML' in obj)
      obj.innerHTML = text;
    else if (typeof console !== 'undefined' && typeof console.error === 'function')
      console.error('Neither text nor textContent nor innerText nor innerHTML is present on element ', obj, ' ' + obj.tagName);
  }

  function elem(tag, style, parent) {

    var e = tag.tagName ? tag : this.document.createElement(tag);

    if (!parent && style && style.tagName) {
      parent = style;
      style = null;
    }

    if (style) {
      if (typeof style === 'string') {
        setText(e, style);
      }
      else {
        for (var k in style) if (style.hasOwnProperty(k)) {
          if (k === 'text') {
            setText(e, style[k]);
          }
          else if (k === 'className') {
            e.className = style[k];
          }
          else {
            try {
              e.style[k] = style[k];
            }
            catch (err) {
              try {
                if (typeof console !== 'undefined' && typeof console.error === 'function')
                  console.error(e.tagName+'.style.'+k+'='+style[k]+': '+err.message);
              }
              catch (whatevs) {
                alert(e.tagName+'.style.'+k+'='+style[k]+': '+err.message);
              }
            }
          }
        }
      }
    }

    if (parent) {
      try {
      parent.appendChild(e);
      }
      catch (error) {
        throw new Error(error.message+' adding '+e.tagName+' to '+parent.tagName);
      }
    }

    return e;
  } // elem


  function downloadText(url, jsonpcallback, callback) {
    if (!callback) {
      callback = jsonpcallback;
      jsonpcallback = null;
    }

    var xhr = typeof XMLHttpRequest === 'function' ? new XMLHttpRequest() : new ActiveXObject('MSXML2.XMLHTTP.3.0');
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState!==4) return;
      if (xhr.status!==200) {
        if (!jsonpcallback) {
          callback(null);
          return;
        }
      }
      else {
        callback(xhr.responseText || xhr.response);
      }
    };
    xhr.send();
  }


  function renderStyle() {/*
    body {
      border: none;
      background: white;
      color: black;
      overflow: auto;
    }
  */}

} // bootMD


// this one is not preserved when saving
function defaultMD() {/*

## Are you ready???

*/
}

//</script>
